import time
import smbus

# Äá»‹a chá»‰ I2C cá»§a ADS1115
ADS_ADDR = 0x48
bus = smbus.SMBus(1)

# Cáº¥u hÃ¬nh Ä‘Æ¡n giáº£n cho kÃªnh A0, PGA Â±4.096V, single-shot
ADS1115_REG_CONVERSION = 0x00
ADS1115_REG_CONFIG = 0x01
CONFIG_A0 = 0xC183  # OS=1, MUX=100 (AIN0-GND), PGA=Â±4.096V, MODE=single-shot

# CÃ¡c thÃ´ng sá»‘ cá»§a cáº£m biáº¿n ACS712
ACS712_SENSITIVITY = 0.185  # (V/A) cho ACS712-5A (0.100 cho 20A, 0.066 cho 30A)
VCC = 3.3  # hoáº·c 5.0 tÃ¹y theo báº¡n cáº¥p nguá»“n gÃ¬
ACS712_ZERO_VOLTAGE = VCC / 2  # á» dÃ²ng 0A, Ä‘iá»‡n Ã¡p Ä‘áº§u ra náº±m á»Ÿ giá»¯a VCC

def read_adc_voltage():
    try:
        config_hi = (CONFIG_A0 >> 8) & 0xFF
        config_lo = CONFIG_A0 & 0xFF
        bus.write_i2c_block_data(ADS_ADDR, ADS1115_REG_CONFIG, [config_hi, config_lo])
        time.sleep(0.01)
        data = bus.read_i2c_block_data(ADS_ADDR, ADS1115_REG_CONVERSION, 2)
        raw = (data[0] << 8) | data[1]

        if raw > 32767:
            raw -= 65536

        voltage = raw * 4.096 / 32768.0  # Full scale Â±4.096V
        return round(voltage, 4)
    except Exception as e:
        print("âŒ Error reading ADS1115:", e)
        return None

def calculate_current(voltage):
    # DÃ²ng Ä‘iá»‡n tÃ­nh báº±ng Ä‘á»™ lá»‡ch so vá»›i Ä‘iá»‡n Ã¡p zero (trung Ä‘iá»ƒm), chia cho Ä‘á»™ nháº¡y
    delta_v = voltage - ACS712_ZERO_VOLTAGE
    current = delta_v / ACS712_SENSITIVITY
    return round(current, 3)

# Äá»c liÃªn tá»¥c
if __name__ == "__main__":
    while True:
        voltage = read_adc_voltage()
        if voltage is not None:
            current = calculate_current(voltage)
            print(f"ğŸ”Œ Voltage: {voltage} V | âš¡ Current: {current} A")
        else:
            print("âš ï¸ KhÃ´ng Ä‘á»c Ä‘Æ°á»£c dá»¯ liá»‡u ADC.")
        time.sleep(1)
