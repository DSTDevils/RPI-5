import time
import smbus

# Äá»‹a chá»‰ I2C cá»§a ADS1115
ADS_ADDR = 0x48
bus = smbus.SMBus(1)

# Thanh ghi ADS1115
ADS1115_REG_CONVERSION = 0x00
ADS1115_REG_CONFIG = 0x01

# Cáº¥u hÃ¬nh: Ä‘Æ¡n giáº£n Ä‘á»ƒ Ä‘á»c kÃªnh 0 (AIN0)
# PGA = Â±4.096V, tá»‘c Ä‘á»™ 128SPS, cháº¿ Ä‘á»™ single-shot
CONFIG_CHANNEL_0 = 0xC183  # OS=1, MUX=100 (AIN0-GND), PGA=Â±4.096V, MODE=single-shot

def read_adc_channel0():
    try:
        # Gá»­i cáº¥u hÃ¬nh Ä‘á»ƒ báº¯t Ä‘áº§u chuyá»ƒn Ä‘á»•i
        config_hi = (CONFIG_CHANNEL_0 >> 8) & 0xFF
        config_lo = CONFIG_CHANNEL_0 & 0xFF
        bus.write_i2c_block_data(ADS_ADDR, ADS1115_REG_CONFIG, [config_hi, config_lo])
        time.sleep(0.01)  # Chá» chuyá»ƒn Ä‘á»•i

        # Äá»c dá»¯ liá»‡u ADC (2 byte)
        data = bus.read_i2c_block_data(ADS_ADDR, ADS1115_REG_CONVERSION, 2)
        raw = (data[0] << 8) | data[1]

        # Xá»­ lÃ½ giÃ¡ trá»‹ signed
        if raw > 32767:
            raw -= 65536

        # Chuyá»ƒn Ä‘á»•i sang Ä‘iá»‡n Ã¡p
        voltage = raw * 4.096 / 32768.0  # Â±4.096V full scale
        return raw, round(voltage, 4)
    except Exception as e:
        print("âŒ Error reading ADS1115:", e)
        return None, None

# Cháº¡y thá»­: Ä‘á»c liÃªn tá»¥c má»—i 0.5s
if __name__ == "__main__":
    while True:
        raw_val, volt = read_adc_channel0()
        if raw_val is not None:
            print(f"ğŸ”Š ADC Raw: {raw_val} | Voltage: {volt} V")
        else:
            print("âš ï¸ KhÃ´ng Ä‘á»c Ä‘Æ°á»£c dá»¯ liá»‡u tá»« ADS1115.")
        time.sleep(0.5)
